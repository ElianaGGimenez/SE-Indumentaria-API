<h1>Productos (PÃ¡gina {{page}} / {{totalPages}})</h1>

<ul>
  {{#each products}}
    <li>
      <img src="{{this.img}}" width="80" alt="{{this.nombre}}"/>
      <a href="/products/{{this._id}}">{{this.nombre}}</a>
      - ${{this.precio}}
      <form style="display:inline" onsubmit="addToCart(event, '{{this._id}}')">
        <button type="submit">Agregar al carrito</button>
      </form>
    </li>
  {{/each}}
</ul>

<div>
  {{#if hasPrevPage}}
    <a href="/products?page={{prevPage}}">Anterior</a>
  {{/if}}
  {{#if hasNextPage}}
    <a href="/products?page={{nextPage}}">Siguiente</a>
  {{/if}}
</div>

<script>
  async function addToCart(e, pid){
    e.preventDefault();
    let cartId = localStorage.getItem('cartId');
    if(!cartId){
      const res = await fetch('/api/carts', { method: 'POST' });
      const data = await res.json();
      cartId = data.payload._id;
      localStorage.setItem('cartId', cartId);
    }
    const cartIdNow = cartId;
    await fetch(`/api/carts/${cartIdNow}/product/${pid}`, { method: 'POST' });
    alert('Producto agregado al carrito');
  }
</script>
